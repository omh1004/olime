import {selectCity} from '../common/selectCity.js'
import {checkCourtType, checkIndoor, checkParking} from '../common/typeCheck.js'
import {
    fieldList,
    getCourt,
    courtList,
    findRegion,
    findCity,
    rsvsByDate
} from '../common/apiList.js'


// ***ÏòàÏïΩ ÌéòÏù¥ÏßÄÎ°ú ÎÑòÍ∏∏ Îç∞Ïù¥ÌÑ∞
var expectedRsv = {
    fieldId: '',
    courtId: '',
    date: '',
    day: '',
    time: ''
};

// ÌòÑÏû¨ ÎÇ†Ïßú
let today = new Date();
let now = today.getHours();
console.log(now);

// ÎÇ†Ïßú ÌòïÏãù YYMMDD
let month = ("0" + (today.getMonth() + 1)).slice(-2);
let year = ("0" + today.getFullYear()).slice(-2);
let date = today.getDate();
expectedRsv.date = year + month + ("0" + date).slice(-2); // ***YYMMDD ÌòïÌÉúÎ°ú ÌòÑÏû¨ ÎÇ†Ïßú ÎîîÌè¥Ìä∏Î°ú Îã¥ÏïÑÎëêÍ∏∞
const WEEKDAY = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
expectedRsv.day = WEEKDAY[today.getDay()];


// ÏßÄÎÇú ÏãúÍ∞Ñ ÎßàÍ∞ê Ï≤òÎ¶¨
timeCheck(now);




// =====================================
//             Ïπ¥Ïπ¥Ïò§ ÏßÄÎèÑ API
// =====================================

var container = document.getElementById('map'); //ÏßÄÎèÑÎ•º Îã¥ÏùÑ ÏòÅÏó≠Ïùò DOM Î†àÌçºÎü∞Ïä§
var options = { //ÏßÄÎèÑÎ•º ÏÉùÏÑ±Ìï† Îïå ÌïÑÏöîÌïú Í∏∞Î≥∏ ÏòµÏÖò
    center: new kakao.maps.LatLng(37.499, 127.029), //ÏßÄÎèÑÏùò Ï§ëÏã¨Ï¢åÌëú.
    level: 6 //ÏßÄÎèÑÏùò Î†àÎ≤®(ÌôïÎåÄ, Ï∂ïÏÜå Ï†ïÎèÑ)
};

var map = new kakao.maps.Map(container, options); //ÏßÄÎèÑ ÏÉùÏÑ± Î∞è Í∞ùÏ≤¥ Î¶¨ÌÑ¥

// ÎßàÏª§Ïùò Ïù¥ÎØ∏ÏßÄÏ†ïÎ≥¥Î•º Í∞ÄÏßÄÍ≥† ÏûàÎäî ÎßàÏª§Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§
var markerImage = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', // ÎßàÏª§Ïù¥ÎØ∏ÏßÄÏùò Ï£ºÏÜåÏûÖÎãàÎã§
    new kakao.maps.Size(44, 49), // ÎßàÏª§Ïù¥ÎØ∏ÏßÄÏùò ÌÅ¨Í∏∞ÏûÖÎãàÎã§
    {offset: new kakao.maps.Point(27, 69)}); // ÎßàÏª§Ïù¥ÎØ∏ÏßÄÏùò ÏòµÏÖòÏûÖÎãàÎã§. ÎßàÏª§Ïùò Ï¢åÌëúÏôÄ ÏùºÏπòÏãúÌÇ¨ Ïù¥ÎØ∏ÏßÄ ÏïàÏóêÏÑúÏùò Ï¢åÌëúÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§.

// ÎßàÏö∞Ïä§ Ìú†Î°ú ÏßÄÎèÑ ÌôïÎåÄ,Ï∂ïÏÜå Í∞ÄÎä•Ïó¨Î∂ÄÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§
map.setZoomable(false);

// Ï§ëÏã¨Ï¢åÌëú Î∂ÄÎìúÎüΩÍ≤å Ïù¥ÎèôÌïòÍ∏∞
function panTo(lat, lng) {
    // Ïù¥ÎèôÌï† ÏúÑÎèÑ Í≤ΩÎèÑ ÏúÑÏπòÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§
    var moveLatLon = new kakao.maps.LatLng(lat, lng);

    // ÏßÄÎèÑ Ï§ëÏã¨ÏùÑ Î∂ÄÎìúÎüΩÍ≤å Ïù¥ÎèôÏãúÌÇµÎãàÎã§
    // ÎßåÏïΩ Ïù¥ÎèôÌï† Í±∞Î¶¨Í∞Ä ÏßÄÎèÑ ÌôîÎ©¥Î≥¥Îã§ ÌÅ¨Î©¥ Î∂ÄÎìúÎü¨Ïö¥ Ìö®Í≥º ÏóÜÏù¥ Ïù¥ÎèôÌï©ÎãàÎã§
    map.panTo(moveLatLon);
};




// =====================================
//           Ï†ÑÏ≤¥ ÏΩîÌä∏ ÎßàÏª§ ÎøåÎ¶¨Í∏∞
// =====================================

var marker, markerPosition;

(async function () {
    const response = await fieldList();

    response?.map((court) => {
        // ÎßàÏª§Í∞Ä ÌëúÏãúÎê† ÏúÑÏπòÏûÖÎãàÎã§
        markerPosition = new kakao.maps.LatLng(court.lat, court.lng);

        // ÎßàÏª§Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§
        marker = new kakao.maps.Marker({
            position: markerPosition,
            image: markerImage, // ÎßàÏª§Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
            clickable: true  // ÎßàÏª§Î•º ÌÅ¥Î¶≠ÌñàÏùÑ Îïå ÏßÄÎèÑÏùò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Í∞Ä Î∞úÏÉùÌïòÏßÄ ÏïäÎèÑÎ°ù ÏÑ§Ï†ïÌï©ÎãàÎã§
        });

        // ÎßàÏª§Í∞Ä ÏßÄÎèÑ ÏúÑÏóê ÌëúÏãúÎêòÎèÑÎ°ù ÏÑ§Ï†ïÌï©ÎãàÎã§
        marker.setMap(map);
    })
})();

function getCitiName(e) {
    // ÏãúÎèÑ ‚Üí ÏãúÍµ∞Íµ¨
    selectCity(e.target.value);
}




// =====================================
//   ÏãúÎèÑ/ÏãúÍµ∞Íµ¨ sorting & Ï§ëÏã¨Ï¢åÌëú ÎøåÎ¶¨Í∏∞
// =====================================

// ÏãúÎèÑ
$('#drop-region').on('change', async function (e) {
    e.preventDefault();
    e.stopPropagation();

    // ÏΩîÌä∏ Ïπ¥Îìú Î¶¨ÏÖã
    let card = $('#crt-card');
    if ($('#crt-card div') != null) {
        card.empty()
    };

    // ÏãúÎèÑ ‚Üí ÏãúÍµ∞Íµ¨
    selectCity(e.target.value);

    const coordinateRegion = await findRegion(Number($('#drop-region option:selected').val()));
    let regionLat = coordinateRegion.region?.regionLat;
    let regionLng = coordinateRegion.region?.regionLng;

    // Ï§ëÏã¨Ï¢åÌëú Ïù¥Îèô
    panTo(regionLat, regionLng);

    // Ï§ëÏã¨Ï¢åÌëú Î∞òÍ≤Ω ÎÇ¥Ïóê ÏûàÎäî ÌÖåÎãàÏä§Ïû• Î¶¨Ïä§Ìä∏
    const crtByRegion = await courtList(regionLat, regionLng);

    crtByRegion?.map((fields) => {
        card.append(
            `<div class="card-cover swiper-slide">
                <button class="card-btn card border-0" type="button" data-value="${fields.fieldId}">
                    <div class="card-body">
                        <h5 class="card-title" style="height: 48px">${fields.name}</h5>
                        <p class="card-text">#${checkCourtType(fields.courtTypeId)}</p>
                        <div class="content3">
                            <p class="card-text">${fields.distance} km</p>
                            <a href="view.html?fieldId=${fields.fieldId}" class="btn btn-sm info-btn">Ï†ïÎ≥¥</a>
                        </div>
                    </div>
                </button>
            </div>`
        );
    });

    if (sessionStorage.getItem('fieldId') != null) {
        let fieldId = sessionStorage.getItem('fieldId');
        $(`.card-btn[data-value=${fieldId}]`).click();
    }
});

// ÏãúÍµ∞Íµ¨
$('#drop-city').on('change', async function (e) {
    e.preventDefault();
    e.stopPropagation();

    // ÏΩîÌä∏ Ïπ¥Îìú Î¶¨ÏÖã
    let card = $('#crt-card');
    if ($('#crt-card div') != null) {
        card.empty();
    };

    let city = $('#drop-city option:checked').text();
    let regionNo = $('#drop-region option:selected').val();

    const coordiCity = await findCity(city, regionNo);

    let cityLat = coordiCity.cityLat;
    let cityLng = coordiCity.cityLng;

    panTo(cityLat, cityLng);

    const crtByCity = await courtList(cityLat, cityLng);

    crtByCity?.map((fields) => {
        card.append(
            `<div class="card-cover swiper-slide">
                <button class="card-btn card border-0" type="button" data-value="${fields.fieldId}">
                    <div class="card-body">
                        <h5 class="card-title" style="height: 48px">${fields.name}</h5>
                        <p class="card-text">#${checkCourtType(fields.courtTypeId)}</p>
                        <div class="content3">
                            <p class="card-text">${fields.distance} km</p>
                            <a href="view.html?fieldId=${fields.fieldId}" class="btn btn-sm info-btn">Ï†ïÎ≥¥</a>
                        </div>
                    </div>
                </button>
            </div>`);
    });

    if (sessionStorage.getItem('fieldId') != null) {
        let fieldId = sessionStorage.getItem('fieldId');
        $(`.card-btn[data-value=${fieldId}]`).click();
    }
});




// =====================================
//             Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú Ìö®Í≥º
// =====================================

var fieldId;

$(document).on('click', '.card-btn', async function (e) {
    // Ïπ¥Îìú css Ìö®Í≥º Ïú†ÏßÄ
    $('.card').removeClass('selected-card');
    $(this).addClass('selected-card');
    $('.info-btn').removeClass('changed-color');
    $(this).find('.info-btn').addClass('changed-color');

    // scroll Ïù¥Îèô
    var offset = $('#swiper-temp2').offset();
    $('html').animate({scrollTop: offset.top}, 400);
    // window.scrollTo({ left: 0, top: 750, behavior: "smooth" });

    // ÏÑ†ÌÉùÎêú Ïπ¥Îìú(ÌÖåÎãàÏä§Ïû•) field_id Í∞í Ï∞æÍ∏∞
    fieldId = $(this).closest('.card-btn').attr('data-value');


    // ***ÏÑ†ÌÉùÌïú ÌÖåÎãàÏä§Ïû• Î≤àÌò∏ Îã¥ÏïÑÎëêÍ∏∞
    expectedRsv.fieldId = fieldId;

    // ÏÑ†ÌÉùÎêú Ïπ¥Îìú Ï†ïÎ≥¥ ÌïúÍ∞ú Í∞ÄÏ†∏Ïò§Í∏∞
    let response = await getCourt(fieldId);
    let court = response.data;
    console.log("hereL:::::::::::::::::::::::", court)

    // Ïπ¥Îìú ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÎøåÎ†§Ï£ºÍ∏∞
    $('#crt-name').text(court.name).attr('data-court-id', court.fieldId);
    $('#crt-addr').text(court.addr);
    $('#crt-indYn').text(checkIndoor(court.indYn) + '  ¬∑');
    $('#crt-type').text(checkCourtType(court.courtTypeId) + '  ¬∑');
    $('#crt-parking').text(checkParking(court.parkingArea));

    // ÌòÑÏû¨ ÏòàÏïΩÎêòÏñ¥ ÏûàÎäî ÏãúÍ∞Ñ ÎπÑÌôúÏÑ±Ìôî
    const res = await rsvsByDate(expectedRsv.date, court.fieldId);

    res.data?.map((rsv) => {

        let time = ("0" + rsv.dateTime).slice(-2);
        $(`[data-court=${rsv.courtId}]`).find($(`[data-time=${time}]`)).attr('disabled', true).addClass('closed');
    });
});





// =====================================
//      Ìï¥Îãπ ÎÇ†Ïßú ÏòàÏïΩ Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
// =====================================

// sweetalert
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
})

$(document).on('click', '.date-wrap', async function (e) {
    $('.sche-btn').removeClass('closed').attr('disabled', false);
    let clickedDate = $(e.target).text().slice(0,2);

    if (date == clickedDate) {
        timeCheck(now);
    }
    if (fieldId == null) {
        Toast.fire({
            icon: 'info',
            title: 'Íµ¨Ïû•ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî! üéæ'
        });
    } else {

        // ***ÏÑ†ÌÉù ÎÇ†Ïßú, ÏöîÏùº Îã¥ÏïÑÎëêÍ∏∞
        expectedRsv.date = $(this).attr('data-date');
        expectedRsv.day = $(this).find('span').text();


        const res = await rsvsByDate(expectedRsv.date, expectedRsv.fieldId);
        console.log("date:::::::::::", expectedRsv.date)

        res.data?.map((rsv) => {

            console.log(rsv)

            let time = ("0" + rsv.dateTime).slice(-2);
            $(`[data-court=${rsv.courtId}]`).find($(`[data-time=${time}]`)).attr('disabled', true).addClass('closed');
        })
    }
});




// =====================================
//        ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ°ú Îç∞Ïù¥ÌÑ∞ ÎÑòÍ∏∞Í∏∞
// =====================================
$('.sche-btn').on('click', function (e) {
    if (fieldId != null ) {
        expectedRsv.courtId = $(e.target).parent('div').attr('data-court');
        expectedRsv.time = $(e.target).attr('data-time');

        console.log(expectedRsv);

        let url = new URLSearchParams(expectedRsv).toString();

        sessionStorage.setItem("courtId", expectedRsv.courtId);
        sessionStorage.setItem("fieldId", expectedRsv.fieldId);
        sessionStorage.setItem("date", expectedRsv.date);
        sessionStorage.setItem("region", $('#drop-region').val());
        sessionStorage.setItem("city", $('#drop-city').val());

        location.href = `view.html?${url}`;
    } else {
        Toast.fire({
            icon: 'info',
            title: 'Íµ¨Ïû•ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî! üéæ'
        });
    }
});





// ÏßÄÎÇú ÏãúÍ∞Ñ ÎßàÍ∞ê Ï≤òÎ¶¨ Ìï®Ïàò
function timeCheck(now) {
    for (var i = 6; i <= now; i++) {
        let no;

        if (i < 10) {
            no = '0' + i;
        } else {
            no = i;
        }

        let targetTime = $(`.sche-btn[data-time=${no}]`).attr('data-time');

        if (targetTime <= now) {
            $(`.sche-btn[data-time=${no}]`).attr('disabled', true).addClass('closed');
        }
        i++;
    }
};


console.log("test:::::::::::::::", expectedRsv);




// =====================================
// sessionStorageÏóê Ïú†Ï†ÄÍ∞Ä ÏÑ†ÌÉùÌïú Ï†ïÎ≥¥ Î≥¥Í¥Ä
// =====================================
// localStorage.setItem("v1", "aaa");
// sessionStorage.setItem("v2", "bbb");
console.log(sessionStorage.getItem("courtId"))
console.log(sessionStorage.getItem("fieldId"))
console.log(sessionStorage.getItem("date"))
console.log(sessionStorage.getItem("region"))
console.log(sessionStorage.getItem("city"))

if (sessionStorage.getItem("courtId") != null) {
        $('#drop-region').val(sessionStorage.getItem("region")).change();
        $('#drop-city').val(sessionStorage.getItem("city")).change();
}




// =====================================
//              Ïú†Ï†Ä ÏÑ†Ìò∏ ÏßÄÏó≠
// =====================================
